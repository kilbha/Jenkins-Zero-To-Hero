pipeline {
  agent {
    docker {
      image 'bhars77/maven-java17-docker-agent:latest'
      args '--user root -v /var/run/docker.sock:/var/run/docker.sock' // mount Docker socket to access the host's Docker daemon
    }
  }
  stages {    
    stage('Checkout') {
      steps {
          sh 'sudo rm -rf /var/lib/jenkins/workspace/sprint-boot-app-pipeline-2 || true'
          // deleteDir()          
          // sh "git config --global --add safe.directory '${WORKSPACE}'"
          // sh 'rm -rf /var/lib/jenkins/workspace/sprint-boot-app-pipeline-1'
      }
    }
    
    stage('Build and Test') {
      steps {
        sh 'ls -ltra'
        // build the project and create a JAR file
        sh 'cd java-maven-sonar-argocd-helm-k8s/spring-boot-app && mvn clean package'
      }
    }
    // stage('Static Code Analysis') {
    //   environment {
    //     SONAR_URL = "http:///13.217.225.48:9000"
    //   }
    //   steps {
    //     withCredentials([string(credentialsId: 'sonar_token', variable: 'sonar_token')]) {
    //       sh 'cd java-maven-sonar-argocd-helm-k8s/spring-boot-app && mvn sonar:sonar -Dsonar.login=$sonar_token -Dsonar.host.url=${SONAR_URL}'
    //     }
    //   }
    // }
    stage('Build and Push Docker Image') {
      environment {
        DOCKER_IMAGE = "bhars77/spring-boot-app:${BUILD_NUMBER}"
        // DOCKERFILE_LOCATION = "java-maven-sonar-argocd-helm-k8s/spring-boot-app/Dockerfile"
        REGISTRY_CREDENTIALS = credentials('docker_cred')
      }
      steps {
        script {
            sh 'cd java-maven-sonar-argocd-helm-k8s/spring-boot-app && docker build -t ${DOCKER_IMAGE} .'
            def dockerImage = docker.image("${DOCKER_IMAGE}")
            docker.withRegistry('https://index.docker.io/v1/', "docker_cred") {
                dockerImage.push()
            }
        }
      }
    }
    stage('Scan Docker Image') {
            environment {
              DOCKER_IMAGE = "bhars77/spring-boot-app:${BUILD_NUMBER}"
              // DOCKERFILE_LOCATION = "java-maven-sonar-argocd-helm-k8s/spring-boot-app/Dockerfile"
              REGISTRY_CREDENTIALS = credentials('docker_cred')
            }
            steps {
                script {
                    // Run Trivy to scan the Docker image
                    // def trivyOutput = sh(script: "trivy image $DOCKER_IMAGE", returnStdout: true).trim()
                    def trivyOutput = sh(
                        script: """
                            docker run --rm \
                                -v /var/run/docker.sock:/var/run/docker.sock \
                                aquasec/trivy:latest image --no-progress bhars77/spring-boot-app:${BUILD_NUMBER}
                        """,
                        returnStdout: true
                    ).trim()

                    // Display Trivy scan results
                    println trivyOutput

                    // Check if vulnerabilities were found
                    if (trivyOutput.contains("Total: 0")) {
                        echo "No vulnerabilities found in the Docker image."
                    } else {
                        echo "Vulnerabilities found in the Docker image."
                        // You can take further actions here based on your requirements
                        // For example, failing the build if vulnerabilities are found
                        // error "Vulnerabilities found in the Docker image."
                    }
                }
            }
    }
    stage('Update Deployment File') {
        environment {
            GIT_REPO_NAME = "Jenkins-Zero-To-Hero"
            GIT_USER_NAME = "kilbha"
        }
        steps {
            // withCredentials([string(credentialsId: 'github_token', variable: 'git_token')]) {
            //     sh '''    
            //           git config --global --add safe.directory '*'         
            //           git config user.email ""ci-bot@kilbha.com""
            //           git config user.name "ci-bot"
            //           git pull --rebase origin ci-updates
            //           BUILD_NUMBER=${BUILD_NUMBER}
            //           sed -i "s|image: bhars77/spring-boot-app:.*|image: bhars77/spring-boot-app:${BUILD_NUMBER}|g" java-maven-sonar-argocd-helm-k8s/spring-boot-app-manifests/deployment.yml
            //           git add java-maven-sonar-argocd-helm-k8s/spring-boot-app-manifests/deployment.yml
            //           git commit -m "Update deployment image to version ${BUILD_NUMBER}"
            //           git push https://${git_token}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME} HEAD:ci-updates                                         
            //       '''

            // }
            withCredentials([string(credentialsId: 'github_token', variable: 'git_token')]) {
            sh '''
                rm -rf gitops-clone
                git clone https://${git_token}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git gitops-clone
                cd gitops-clone

                git checkout ci-updates
                git pull --rebase origin ci-updates

                sed -i "s|image: bhars77/spring-boot-app:.*|image: bhars77/spring-boot-app:${BUILD_NUMBER}|g" java-maven-sonar-argocd-helm-k8s/spring-boot-app-manifests/deployment.yml

                git add .
                git commit -m "Update image to version ${BUILD_NUMBER}"
                git push origin ci-updates
              '''
            }
 
        }
    }
    
  }
  post {
        success {
            slackSend color: 'good', message: "Build SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
        }

        failure {
            slackSend color: 'danger', message: "Build FAILED: ${env.JOB_NAME} #${env.BUILD_NUMBER}\nError: ${currentBuild.currentResult}"
        }

        always {
            echo "Build finished"
        }
  }
}
